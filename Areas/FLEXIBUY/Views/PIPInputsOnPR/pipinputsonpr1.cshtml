@model IEM.Areas.FLEXIBUY.Models.PrSumEntity


<link href="@Url.Content("~/Content/themes/base/jquery-ui.css")" rel="stylesheet" type="text/css" />
<script src="@Url.Content("~/Scripts/jquery-ui-1.8.24.min.js")" type="text/javascript"></script>

@{
    ViewBag.Title = "pipinputsonpr";
    Layout = "~/Views/Shared/_Layout.cshtml";

}
<style>
    .pipsl {
        width: 3% !important;
        padding: 3px !important;
        min-width: 30px !important;
    }

    .pipProductGroup {
        width: 10% !important;
        padding: 3px !important;
        min-width: 150px !important;
    }

    .pipProductCode {
        width: 6% !important;
        padding: 3px !important;
        min-width: 100px !important;
    }

    .pipProductName {
        width: 16% !important;
        padding: 3px !important;
        min-width: 200px !important;
    }

    .pipProductDescription {
        width: 21% !important;
        padding: 3px !important;
        min-width: 250px !important;
    }

    .pipUnit {
        width: 5% !important;
        padding: 3px !important;
        min-width: 70px !important;
    }

    .pipQuantity {
        width: 6% !important;
        padding: 3px !important;
        min-width: 80px !important;
        text-align:center !important;
    }

    .pipRate {
        width: 9% !important;
        padding: 3px !important;
        min-width: 100px !important;
        text-align:right;
    }

    .pipestimation {
        width: 8% !important;
        padding: 3px !important;
        min-width: 100px !important;
        text-align:right;
    }

    .pipAttach {
        width: 9% !important;
        padding: 3px !important;
        min-width: 100px !important;
    }

    .pipAction {
        width: 6% !important;
        padding: 3px !important;
        min-width: 60px !important;
        text-align:center;
    }
</style>
@using (Html.BeginForm())
{
    <b>    <span style="color: rgb(52, 108, 196);">PIP Inputs on PRs</span></b>

    <div class="well">
        <div class="panel panel-default" style="margin-bottom:15px;">
            <div>
                @Html.HiddenFor(a => a.prHead.prGid, new { @id = "txtprgid" })
            </div>
            <table class="myTableStyleTabNew" width="100%">
                <tr>
                    <td style="padding:10px; width:20%;">
                        <div>
                            <span>PR Ref No.</span>
                            <br />
                            <div>
                                @Html.TextBoxFor(a => a.prHead.prRefNo, new { @class = "textboxStyleBig", @id = "prrefno", @disabled = "disabled"})
                            </div>
                        </div>
                    </td>
                    <td style="padding:10px; width:20%;">
                        <div>
                            <span>PR Date</span>
                            <br />
                            <div>
                                @Html.TextBoxFor(a => a.prHead.prDate, new { @class = "textboxStyleBig", @id = "prdate", @disabled = "disabled"})
                            </div>
                        </div>
                    </td>
                    <td style="padding:10px; width:20%;">
                        <div>
                            <span>PR Raised by</span>
                            <br />
                            <div>
                                @Html.TextBoxFor(a => a.prHead.prRaisedBy, new { @class = "textboxStyleBig", @id = "prraisedby", @disabled = "disabled" })
                            </div>
                        </div>
                    </td>
                    <td style="padding:10px; width:20%;">
                        <div>
                            <span>FCCC</span>
                            <br />
                            <div>
                                @Html.DropDownList("dropFCCC", Model.ddlFCCC, "--Select Fccc--", new { @class = "textboxStyleBig required", @id = "dropFCCC", @disabled = "disabled" })
                            </div>
                        </div>
                    </td>
                    <td style="padding:10px; width:20%;">
                        <div>
                            <span>Request for</span>
                            <br />
                            <div>
                                @Html.DropDownList("dropRequestfor", Model.ddlRequestfor, "--Select Request--", new { @class = "textboxStyleBig", @id = "dropRequestfor", @disabled = "disabled" })
                            </div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td style="padding:10px;">
                        @{
                            var expense = Model.prHead.prExpense;
                            if (expense != "")
                            {
                                if (expense == "C")
                                {
                        <div>
                            <span>Expenses</span>
                        </div>
                        <div class="radio-inline">
                            <span id="lblcapex">
                                <input type="radio" id="id_rdcap" name="mode1" value="Capex" checked="checked" disabled="disabled" />
                                Capex
                            </span>
                        </div>
                        <div class="radio-inline">
                            <span id="lblopex">
                                <input type="radio" id="id_rdope" name="mode1" value="Opex" disabled="disabled" />
                                Opex
                            </span>
                        </div>
                                }
                                else
                                {
                        <div>
                            <span>Expenses</span>
                        </div>
                        <div class="radio-inline">
                            <span id="lblcapex">
                                <input type="radio" id="id_rdcap" name="mode1" value="Capex" disabled="disabled" />
                                Capex
                            </span>
                        </div>
                        <div class="radio-inline">
                            <span id="lblopex">
                                <input type="radio" id="id_rdope" name="mode1" value="Opex" checked="checked" disabled="disabled" />
                                Opex
                            </span>
                        </div>
                                }
                            }
                        }
                    </td>
                    <td style="padding:10px;">
                        @{
                            var branchtype = Model.prHead.prBranchType;
                            if (branchtype != "")
                            {
                                if (branchtype == "S")
                                {
                        <div>
                            <span>Branch </span>
                        </div>
                        <div class="radio-inline">
                            <span id="lblsingle">
                                <input type="radio" id="id_rdsing" name="mode2" value="Single" disabled checked="checked" />
                                Single
                            </span>
                        </div>
                        <div class="radio-inline">
                            <span id="lblmultiple">
                                <input type="radio" id="id_rdmult" name="mode2" disabled value="Multiples" />
                                Multiple
                            </span>
                        </div>
                                }
                                else
                                {
                        <div>
                            <span>Branch </span>
                        </div>
                        <div class="radio-inline">
                            <span id="lblsingle">
                                <input type="radio" id="id_rdsing" disabled name="mode2" value="Single" />
                                Single
                            </span>
                        </div>
                        <div class="radio-inline">
                            <span id="lblmultiple">
                                <input type="radio" id="id_rdmult" disabled name="mode2" value="Multiples" checked="checked" />
                                Multiple
                            </span>
                        </div>
                                }
                            }
                        }
                    </td>
                    <td style="padding:10px;">
                        <div>
                            <span>Branch</span>
                            <br />
                            <div>
                                @Html.DropDownList("dropBranch", Model.ddlBranch, "--Select Branch--", new { @class = "textboxStyleBig required", @id = "dropBranch",@disabled = "disabled"})
                            </div>
                        </div>
                    </td>
                    <td style="padding:10px;" colspan="2">
                        <div>
                            <span>PR Description</span>
                            <br />
                            <div>
                                @Html.TextBoxFor(a => a.prHead.prDesc, new { @class = "textboxStyleBig", @id = "prdesc", @disabled = "disabled" })
                            </div>
                        </div>
                    </td>
                </tr>
            </table>
        </div>

        <div class=" borderstyle panel panel-default" style="margin-bottom:15px; padding:5px;" id="griddiv">
            <div style="min-width:100%; overflow:auto; height:auto;">
                @Html.Partial("getprdetailsforpip")
            </div>
        </div>
        <div id="tabsat" style="height:100% ;font-size:14px;">
            <ul>
                <li><a href="#tabs-1">Audit Trail</a></li>
                <li><a href="#tabs-2">Attachments</a></li>
            </ul>
            <div id="tabs-1">
                @Html.Partial("tab_auditrail")
            </div>
            <div id="tabs-2">
                @Html.Partial("viewprattachment")
            </div>
        </div>
        
        <table align="center" class="myTableStyleTabNew">
            <tr>
                <td>
                    <span style="padding-left:10px;">Remarks</span>
                    <br />

                    <textarea name="txt_remarks"
                              class="textboxStyle"
                              style="display:block;width:437px;height:89px;"
                              maxlength="264"
                              id="description_pip"></textarea>
                </td>
                <td style="vertical-align:bottom">
                    <a class="btn btn-info" style="color:black;" title="Raise Tickets" onclick="RaiseTicket()"> <b>?</b> </a>
                </td>
            </tr>
        </table><br />
        <table class="myTableStyleTabNew" align="center">
            <tr>
                <td>
                    @*<div style="padding:10px 10px 0px 0px;text-align:center;">*@

                    <button type="button" class="btn btn-success" onclick="fucntionsave()" value="Submit">
                        <span class="glyphicon glyphicon-thumbs-up" style="color:white;"></span> Approve
                    </button>
                </td>
                <td>
                    @*<div style="padding:10px 10px 0px 0px;text-align:center;">*@

                    <button type="button" class="btn btn-danger" onclick="fucntionRejectPIP()" value="Submit">
                        <span class="glyphicon glyphicon-thumbs-down" style="color:white;"></span> Reject
                    </button>
                </td>
                <td>
                    <button type="button" class="btn btn-warning" onclick="back()" value="Back">
                        <span class="glyphicon glyphicon-eye-close" style="color:white;"></span> Back
                    </button>
                </td>
            </tr>
        </table>
        @*<input class="btn btn-success" type="button" value="Submit" onclick='fucntionsave()' />*@
        @*<input class="btn btn-primary" type="button" value="Back" onclick='back()' />*@
        @*</div>*@
    </div>

    <input hidden="hidden" id="nn" />
    <input hidden="hidden" id="aa" />
    <div id="ForPartialViewnew6hh"></div>

    <script>
        var currentTab = 0;
        $(function () {
            $("#tabsat").tabs({
                select: function (e, i) {
                    currentTab = i.index;
                }
            });
        });
        function back() {
           @*location = '@Url.Action("PipSummary", "PIPITInputSummary")?' + new Date().getTime();*@
            location = '@Url.Action("Index","flexibuydashboard")?redirect=yes' + '&' + new Date().getTime();
        }
        var objDialog6;

        function viewattach(id) {

            if ($("#aa").val() == "") {
                $('#aa').val('anu');

                objDialog6 = $("[id$='ForPartialViewnew6hh']");
                objDialog6.dialog({
                    autoOpen: false,
                    modal: true,
                    show: 'fade-in',
                    close: 'fade-out',
                    cache: false,
                    width: 600,
                    height: 400
                });
            }

            objDialog6.load('@Url.Action("viewpipattachment", "PIPInputsOnPR")?id=' + id + '&' + new Date().getTime());
            objDialog6.dialog({ title: 'PIP Attachment List' });
            objDialog6.dialog("open");
        }

        $(document).ready(function () {
            $('#nn').val('');
            $('#aa').val('');
        });
        function fucntionsave() {
           
            var Prrgid = $('#txtprgid').val();
            $.ajax({
                url: '@Url.Action("CheckApproverIsExists", "PIPInputsOnPR")?refgid=' + Prrgid + '&refname=PR&' +  new Date().getTime(),
                type: 'POST',
                async: false,
                cache: false,
                contentType: 'application/json; charset=utf-8',
                success: function (data) {
                    //if (data == 1) {
                    //    jAlert("You Have Already Approved This PR", "Warning", function () {
                    //        return false;
                    //    });
                    //}
                    if (data == 2) {
                        jAlert("You Cannot Approve Now.Something Seems Wrong", "Error", function () {
                            return false;
                        });
                    }
                    else {
                        var prrefno = $('#prrefno').val();
                        var prdate = $('#prdate').val();
                        var prfccc = $("#dropFCCC").val();
                        var prbranchgid = $("#dropBranch").val();
                        var prrequestforgid = $("#dropRequestfor").val();
                        var prdesc = $("#prdesc").val();
                        var prraisedby = $("#prraisedby").val();
                        var rate = $("#prDet_Rate").val();
                        var expense = $('input[name=mode1]:checked').val();
                        var status = $("input[name='mode2']:checked").val();
                        var remarks = $('#description_pip').val();

                        sessionStorage["prrefno"] = prrefno;
                        var prheader = {
                            "prGid": Prrgid,
                            "prRefNo": prrefno,
                            "prDate": prdate,
                            "prFcc": prfccc,
                            "prBranch": prbranchgid,
                            "prDesc": prdesc,
                            "prReqFor": prrequestforgid,
                            "prRaisedBy": prraisedby,
                            "prBranchType": status,
                            "prExpense": expense,
                            "prRemarks": remarks,

                        };

                        //if (remarks == null || remarks == "") {
                        //    jAlert("Please enter Remarks", "Error");
                        //    return false;
                        //}
                        //  alert(remarks);
                        showProgress();
                        $.post('@Url.Action("Pipsave", "PIPInputsOnPR")?' + new Date().getTime(), prheader,
                   function (data) {
                       //  jAlert(data, "Message");
                       hideProgress();
                       if (data == "failed") {
                           jAlert("Please Insert valid Amount", "Message", function () {
                               return false;
                           });
                           return false;
                       }
                       else {// window.location = '../../PIPITInputSummary/PipSummary'
                           jAlert("Successfully Submitted", "Success", function () {
                               location = '@Url.Action("Index","flexibuydashboard")?redirect=yes' + '&' + new Date().getTime();
                           });
                          
                       }
                   }, 'json');

                    }
                },
                error: function (result) {
                    jAlert("Something went wrong", "Error");
                }
            });

         
           

            //      $.post('../../PIPInputsOnPR/Pipsave', prheader,
            //function (data) { if (data == 0) { location = location.href; } else { window.location = '../../PIPInputsOnPR/Download' } }, 'json');
            //}
            //$.post('../../PIPInputsOnPR/PipInputsOnPr1', prheader,
            //              function (data) {
            //                  if (data == 0) { location = location.href; } else {
            //                      jAlert("Saved Successfully", "Sucess", function (r) {
            //                          if (r == true) {
            //                              location = '../../PIPITInputSummary/PipSummary';
            //                          }
            //                      });
            //                  }
            //              }, 'json');
        }
        function fucntionRejectPIP()
        {
            var Prrgid = $('#txtprgid').val();
            $.ajax({
                url: '@Url.Action("CheckApproverIsExists", "PIPInputsOnPR")?refgid=' + Prrgid + '&refname=PR&' + new Date().getTime(),
                type: 'POST',
                async: false,
                cache: false,
                contentType: 'application/json; charset=utf-8',
                success: function (data) {
                    //if (data == 1) {
                    //    jAlert("You Have Already Approved This PR", "Warning", function () {
                    //        return false;
                    //    });
                    //}
                    //else
                    if (data == 2) {
                        jAlert("You Cannot Approve Now.Something Seems Wrong", "Error", function () {
                            return false;
                        });
                    }
                    else {
                        
                        var remarks = $('#description_pip').val();
                        if (remarks == null || remarks.toString().trim() == "") {
                            jAlert("Please Enter Remarks", "Error", function () {
                                $('#description_pip').val("");
                                $('#description_pip').focus();
                                return false;
                            });
                            return false;
                        }
                        var prheader = {
                            "prGid": Prrgid,
                            "prRemarks": remarks
                        };

                        //if (remarks == null || remarks == "") {
                        //    jAlert("Please enter Remarks", "Error");
                        //    return false;
                        //}
                        //  alert(remarks);
                        showProgress();
                        $.post('@Url.Action("PIPRejectPR", "PIPInputsOnPR")?' + new Date().getTime(), prheader,
                       function (data) {
                           //  jAlert(data, "Message");
                           hideProgress();
                           if (data == 0) {
                               jAlert("Error Occured", "Error", function () {
                                   return false;
                               });
                               return false;
                           }
                           else {
                               jAlert("PR Rejected Successfully", "Success", function () {
                                   location = '@Url.Action("Index","flexibuydashboard")?redirect=yes' + '&' + new Date().getTime();
                               });
                           }
                       }, 'json');

                        }
                },
                error: function (result) {
                    jAlert("Something went wrong", "Error");
                }
            });

        }
        function RaiseTicket() {
            var refflagname = "PR";
            var itemrefno =  $("[id=prrefno]").val();
         
            if ($("#aa").val() == "") {
                $('#aa').val('iem');

                objDialog6 = $("[id$='ForPartialViewnew6hh']");
                objDialog6.dialog({
                    autoOpen: false,
                    modal: true,
                    show: 'fade-in',
                    close: 'fade-out',
                    cache: false
                });
            }
           
            objDialog6.load('../../RaiseTickets/SingleTicketNormal?refname=' + refflagname + '&itemrefno=' + itemrefno + '&' + new Date().getTime());
            objDialog6.dialog({
                title: 'Raise Ticket',
                width: 1100,
                height: 500
            });
            objDialog6.dialog("open");
        }
    </script>
}
