@model IEM.Areas.ASMS.Models.SupplierDeActvation

@{
    
}
@using (Html.BeginForm())
{
    <div class="well">
        <table align="center" style="width: 100%;">
            <tr style="display:none;">
                <td><span>Supplier HedaerGid </span></td>
                <td>@Html.TextBoxFor(model => model.DSupplierheadergid, new { @class = "textboxStyle", @readonly = "readonly" })
                @Html.HiddenFor(model => model.logstatus);
                    <input type="text" style="display:none;" class="textboxStyle" id="txtIsExistsFlagDeAct" name="txtIsExistsFlag" value="@Model._IsExistsFlagApprover" />
                    <input type="text" style="display:none;" class="textboxStyle" id="txtIsExistsApproverNameDeAct" name="txtIsExistsApproverName" value="@Model._IsExistsApproverName" />
               
                </td>
            </tr>
            <tr>
                <td>
                    @Html.HiddenFor(model => model.DCurrenStrage)
                    @Html.HiddenFor(model => model.DRequestTypeName)
                </td>
            </tr>
            <tr style="width:100%">

                @*<td colspan="4" align="right"><label style="color:red">@ViewBag.DMessage </label></td>*@
                @*<td colspan="4" align="right"><label style="color:red">@Model.DQueueStatus </label></td>*@
                @*<td colspan="4" align="right" style="color:red">@Html.Label("STW", @Model.DQueueStatus, new { @class = "LabelCSSTop" })</td>*@

            </tr>
            <tr>
                <td>
                    <span style="font-size:12px;">Supplier Code </span><br />
                    @Html.TextBoxFor(model => model.DSupplierCode, new { @class = "textboxStyle", @readonly = "readonly", @style = "font-size:12px;" })
                </td>
                <td style="width:10px;"></td>
                <td>
                    <span style="font-size:12px;">Supplier Name </span><br />
                    @Html.TextBoxFor(model => model.DSupplierName, new { @class = "textboxStyle", @readonly = "readonly", @style = "font-size:12px;" })
                </td>
            </tr>
            @*<tr style="height:20px;"><td></td></tr>
            <tr>
                <td></td>

            </tr>*@
            <tr style="height:15px;"><td></td></tr>
            @*<tr>
                <td><label>From Date :</label></td>
                <td><input id="FromDate" type="text" class="form-control" name='@Html.NameFor(x=>x.Fromdate)' value="@Model.Fromdate"></td>
            </tr>*@
            @*<tr style="height:20px;"><td></td></tr>*@
            @*<tr>
                <td><label>To Date :</label></td>
                <td>
                    <input id="Todate" type="text" class="form-control" name='@Html.NameFor(x=>x.Todate)' value="@Model.Todate" readonly />
                </td>
            </tr>*@

            <tr>

                <td>
                    <span style="font-size:12px;">DeActivate Reason </span><br />
                    @Html.TextBoxFor(model => model.DeActiveReason, new { @style = "width:390px;height:110px;font-size:12px;", @cols = "30", @rows = "4", @readonly = "readonly" })
                    @*<textarea class="form-control" cols="30" rows="4" id="txtDeActivatereason" maxlength="128" name='@Html.NameFor(x=>x.DeActiveReason)' value="@Model.DeActiveReason"> </textarea>*@
                </td>
                <td style="width:10px;"></td>
                <td>
                    <span style="font-size:12px;">Comments </span><br />
                    @Html.TextBoxFor(model => model.Decomments, new { @style = "width:390px;height:110px;font-size:12px;", @cols = "30", @rows = "4", @readonly = "readonly" })
                    @*<textarea class="form-control" cols="30" maxlength="128" rows="4" name='@Html.NameFor(x=>x.Decomments)' value="@Model.Decomments"> </textarea>*@
                </td>
                <td style="width:10px;"></td>
            </tr>
            <tr style="height:15px;"><td colspan="4"></td></tr>

            <tr>
                <td colspan="4" align="center">
                    <span>Attachments </span><br />
                    <div id="wgAttachmentsupplier">
                        @{
    var gridAttachment = new WebGrid(Model.DAttchList, canSort: false, canPage: false, rowsPerPage: 3, ajaxUpdateContainerId: "wgAttachmentsupplier", ajaxUpdateCallback: "DummyFunction()");
    int rowValAttachment = 0;
                        }

                        <div class="container" style="width:800px;font-size:12px;">
                            <div>
                                @gridAttachment.GetHtml(
                                       htmlAttributes: new { id = "wgAttachmentsupplier" },
                     tableStyle: "tableSmall table-bordered table-hover table-responsive",
                        mode: WebGridPagerModes.All,
                        columns:
                gridAttachment.Columns(
        //gridAttachment.Column("#", canSort: false, format: item => rowValAttachment = rowValAttachment + 1),
        // gridAttachment.Column("Attachid", objCmnFunctions.Sorter("Attachid", "Slno", gridAttachment), canSort: false),
        // gridAttachment.Column("DAttachid", "Slno", format: @<text>  <span> <label id="lblgid">@item.DAttachid</label> </span> <input type="text" id="gid" value="@item.DAttachid" style="display:none;" /></text>, style: "col2Width"),
        // gridAttachment.Column("AttachFileName", objCmnFunctions.Sorter("AttachFileName", "Attachment Name", gridAttachment), canSort: false),
                         gridAttachment.Column("DAttachFileName", "Attachment Name", format: @<text>  <span> <label id="lblName">@item.DAttachFileName</label> </span> <input type="text" name="attachedfile4" id="Name" value="@item.DAttachFileName" style="display:none;" /></text>, style: "col2Width"),
                                                 //   gridAttachment.Column("AttachFileType", objCmnFunctions.Sorter("AttachFileType", "Attachment Type", gridAttachment), canSort: false),
                                //  gridAttachment.Column("AttachmentDescription", objCmnFunctions.Sorter("AttachmentDescription", "Description", gridAttachment), canSort: false),
                          gridAttachment.Column("DAttachdate", "Attachment Date"),
                                                  //  gridAttachment.Column("Insertby", objCmnFunctions.Sorter("Insertby", "Attached By", gridAttachment), canSort: false),
                                  gridAttachment.Column(header: "Action", canSort: false, style: "action",
                format: @<text>
                                    @*@Html.Raw("<a data-modal='' href='/EOW/EmployeeClaimnew/Download/" + item.AttachmentFilenameId + "' id='" + item.AttachmentFilenameId + "' title='Detail'> <span class='glyphicon glyphicon-search'> </span> </a>")
                                    @if (item.attachment_by == objCmnFunctions.GetLoginUserGid())
                                    {
                                        @Html.Raw("<a data-modal='' href='/EOW/EmployeeClaimnew/Download/" + item.Attachid + "' id='" + item.Attachid + "'  title='Delete'   > <span class='glyphicon glyphicon-trash'> </span> </a>")
                                    }*@
                          <a onclick="DownloadApprovalAttachments4(this)"><span class='glyphicon glyphicon-eye-open cursorpointer'></span></a>
                                    
                                    @*@Html.Raw("<input type='button' class='glyphicon glyphicon-trash cursorpointer' id='btnremove'  Onclick='remove1(" + item.Attachid + ")'  />")*@
                                    @*<span class='glyphicon glyphicon-trash cursorpointer'></span>*@
                                    @*<input type='button' id='btnremove' class="glyphicon glyphicon-trash cursorpointer" onclick='remove1(" + item.Attachid + ")' />*@


                            </text>
)
)
)
                            @if (Model.DAttchList.Count == 0)
                            {

                                <label style="padding:10px;">No Records Found</label>

                            }

</div>
                        </div>
                    </div>
                </td>
            </tr>


            <tr style="height:10px;"><td colspan="4"></td></tr> 
            <tr id="trApproval">
                <td colspan="4" align="center">
                    <div>
                        <table align="center">
                            <tr>
                                <td colspan="2" align="center" style="padding:5px">
                                    <span style="font-size:12px;">Approved</span>
                                    @Html.RadioButtonFor(model => model.DApproval, "1", new { @id = "rtbApproval", @checked = "checked" })
                                    &nbsp;&nbsp;&nbsp;&nbsp;
                                    <span style="font-size:12px;">Reject</span>
                                    @Html.RadioButtonFor(model => model.DReject, "0", new { @id = "rtbReject" })
                                </td>
                            </tr>
                            <tr style="height:10px;"><td ></td></tr> 
                            <tr id="trNextApproverLabel">
                                <td>
                                    <span>Next Approval Stage</span>
                                </td>
                                <td>
                                    <input type="text" id="txtNextApprovalQueue" name="txtNextApprovalQueue" class="textboxStyle" />
                                </td>
                            </tr>
                            <tr id="trOptionalChk">
                                <td colspan="2" style="max-width:100%;text-wrap:normal;">
                                    <input type="checkbox" id="IsPushApproval" name="IsPushApproval" value="Y" />
                                    <span id="lblOptionalFieldChk"></span>
                                </td>
                            </tr>
                            <tr id="trOptionalField">
                                <td><span id="spnOptionalFieldName"></span></td>
                                <td>
                                    <input type="hidden" name="txtNextApproverGid" id="txtNextApproverGid" value="@Model.Dqueueto" />
                                    &nbsp;&nbsp;<input type="text" name="txtNextApprover" id="txtNextApprover" class="textboxStyleMedium">
                                    &nbsp;&nbsp;&nbsp;<a onclick="GetNextApprover()" id="btnEmployeeSearchApproval"><span class="glyphicon glyphicon-search"></span></a>
                                </td>
                            </tr>
                            <tr>

                                <td style="padding:5px">
                                    <span style="font-size:12px;">Remarks </span> <br />
                                    <textarea cols="30" rows="4" id="txtDRemarks" class="textareaStyle" style="resize:none;width:400px;height:110px" name='@Html.NameFor(x=>x.DRemarks)' maxlength="128" value="@Model.DRemarks"> </textarea>
                                </td>
                            </tr>
                        </table>
                    </div>
                </td>
            </tr>







            <tr style="height:15px;"><td></td></tr>
            <tr>
                <td colspan="3" align="center">
                    @*<input type="submit" name="SUBMIT" id="btnDeactivate" value="SUBMIT"  class="btn btn-primary" />*@
                    <input name="SUBMIT" id="btnDeactivate" value="SUBMIT" onclick="RequiredFieldChecking()" class="btn btn-primary" />
                    @*<input type="button" name="BACK" onclick="location.href='@Url.Action("SupplierDeActivation","SupplierDeActivationQueue")'" value="BACK" class="btn btn-primary" />*@
                    <input type="button" name="BACK" onclick="BackToDashboardDeAct()" value="BACK" class="btn btn-primary" />
                </td>
            </tr>
        </table>

    </div>
    <div id="divApprovalpopup"></div>
}

<script>
    /*Ramya 29 Oct 18*/
    var objDialogIndex;
    $(document).ready(function () {
        objDialogIndex = $("[id$='divApprovalpopup']");
        objDialogIndex.dialog({
            autoOpen: false,
            closeOnEscape: false,
            modal: true,
            async: false,
            show: 'fade-in',
            close: 'fade-out',
            //width: 660,
            //height: 470,
            cache: false

        });

    });
    function GetNextApprover() {
        objDialogIndex.load('../Onboarding/SearchEmployee?listfor=new&formname=approver&' + new Date().getTime());
        objDialogIndex.dialog({ title: 'Search Next Approver', width: '660', height: '570' });
        objDialogIndex.dialog("open");
    }
    function SelectEmployee(element, id) {
        var row = $(element).closest('tr');
        var empgid = row.find('td:eq(0)').text();
        var empcode = row.find('td:eq(2)').text();
        var empname = row.find('td:eq(3)').text();
        $("#txtNextApproverGid").val(empgid);
        $("#txtNextApprover").val(empcode + "-" + empname);
        window.parent.jQuery('#divApprovalpopup').dialog('close');
    }
    function RequiredFieldChecking() {
        
        var actionremark = "";
        var queueto = "";
        var actionstatus = 1;
        var skipflag = 0;
        var currentstage = '@Model.DCurrenStrage';
        if ($("#rtbApproval").is(':checked')) {
            actionstatus = 1;
        }
        else
            actionstatus = 0;
        actionremark = $("#txtDRemarks").val();
        var requesttype = "@Model.DRequestTypeName";
        if (queuetotype == "I") {
            if (ismandatoryqueue == "N") {
                if ($("#IsPushApproval").is(':checked')) {
                    skipflag = 0;
                    queueto = $("#txtNextApproverGid").val();
                    if (queueto == null || $.trim(queueto) == "") {
                        jAlert("Please Select Next Approver..", "Error", function () {
                            $("#txtNextApproverGid").focus();
                            hideProgress();
                            return false;
                        });
                        hideProgress();
                        return false;
                    }
                }
                else {
                    skipflag = 1;
                    if (currentstage == 1) {
                        queueto = "12";
                    }
                    else {
                        queueto = "14";
                    }
                }
            }
            else if (ismandatoryqueue == "Y") {
                skipflag = 0;
                if (currentstage == 1) {
                    queueto = "12";
                }
                else {
                    queueto = "14";
                }
                //queueto = $("#txtNextApproverGid").val();
                //if (queueto == null) {
                //    jAlert("Please Select Next Approver..", "Error", function () {
                //        $("#txtNextApproverGid").focus();
                //        hideProgress();
                //        return false;
                //    });
                //    hideProgress();
                //    return false;
                //}
            }
        }
        else {
            if (queuetotype == "G") {
                if (ismandatoryqueue == "N") {
                    if ($("#IsPushApproval").is(':checked')) {
                        skipflag = 0;
                    }
                    else {
                        skipflag = 1;
                    }
                }
            }
            else if (ismandatoryqueue == "Y") {
                skipflag = 0;
                queueto = $("#txtNextApprovalQueue").val();
            }
        }
        if ($.trim(actionstatus).toString() == "0") {
            if (actionremark == "" || actionremark == null) {
                jAlert("Please Enter Remarks..", "Error", function () {
                    $("#txtDRemarks").focus();
                    hideProgress();
                    return false;
                });
                hideProgress();
                return false;
            }
        }
        var objApprovalModel = {
            "DRequestTypeName": requesttype,
            "DRemarks": actionremark,
            "DApproverid": queueto,
            "DApproval": actionstatus,
            "DskipFlag": skipflag,
            "DSupplierheadergid": supheadgid
        };
        $.post('../SupplierDeActivationApprovalQueue/SupplierApproveDeActivation', objApprovalModel,
            function (data) {
                if (data == "success" || data=="Rejected") {
                    submitflag = 1;

                }
                else if (data == "error") {
                    jAlert("Something went wrong" + data, "Error", function () {
                        hideProgress();
                        return false;
                    });

                }
                else {
                    jAlert(data, "Error", function () {
                        hideProgress();
                        return false;
                    });
                }
                hideProgress();
                window.location.href = "@Url.Action("Dashboard", "AsmsMain")";
            },
           'json');
    }
    /*Ramya 29 Oct 18*/
    function DownloadApprovalAttachments4(element) {
        var row = $(element).closest('tr');
        var fi = row.find($("input[name=attachedfile4]")).val();
       // alert(fi);
        location = "../Onboarding/DownloadDocument?id=" + fi;
    }
    function BackToDashboardDeAct() {
        var supcode = '@Model.DSupplierCode';
        var objSupHeaderDetails = {
            "_SupplierCode": supcode
        };

        $.ajax({
            url: '@Url.Action("ReleaseMySupplier", "Onboarding")',
            data: JSON.stringify(objSupHeaderDetails),
            type: 'POST',
            async: false,
            cache: false,
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                location = "../AsmsMain/Dashboard?" + new Date().getTime();
            },
            error: function (result) {
                jAlert("Something went wrong", "Error");
            }
        });
    
    }
    // 
    var dirCount;
    var currentapprovalstage = parseInt(@Model.DCurrenStrage);
    var requesttype;
    var queuetotype;
    var currentstage;
    var nextlevel;
    var ismandatoryqueue;
    var supheadgid = parseInt(@Model.DSupplierheadergid);
    // alert(supheadgid);
    var isallowapprovertoedit = parseInt(@ViewBag.IsAllowApproverToEdit);
    var nextstagename;
    $(document).ready(function () {
        //
        var rdbval = $(this).val();
        var requesttype1 = '@Model.DRequestTypeName';
        var currentstage = '@Model.DCurrenStrage';
        //alert(requesttype1);
        var objApprovalModel = {
            "_RequestType": requesttype1,
            "_QueueCurrentLevel": currentstage
        };

        $.ajax({
            url: '../Onboarding/GetNextApprovalStage',
            data: JSON.stringify(objApprovalModel),
            type: 'POST',
            async: false,
            cache: false,
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                if (data.length > 0) {
                    for (var i = 0; i < data.length; i++) {
                        ismandatoryqueue = data[i]._NextApprovalIsMandatory;
                        nextstagename = data[i]._NextApprovalGroup;
                        nextlevel = data[i]._QueueCurrentLevel;
                        queuetotype = data[i]._QueueToType;
                    }

                    if (queuetotype = "I") {
                        $("#trOptionalField").css("display", "block");
                    }
                    else if (queuetotype = "G") {
                        $("#trOptionalField").css("display", "none");
                    }
                    if (ismandatoryqueue == "N") {
                        //alert(3);
                        $("#trOptionalChk").css("display", "block");
                        $("#trOptionalField").css("display", "block");
                        $("#spnOptionalFieldName").text("Select " + nextstagename);
                        $("#lblOptionalFieldChk").text("Is " + nextstagename + " Approval Required?");
                        $("#txtNextApprover").prop("disabled", true);
                        $("#trNextApproverLabel").css("display", "none");
                        $("#btnEmployeeSearchApproval span").prop("disabled", true);
                    }
                    else {
                        // alert(2);
                        $("#trOptionalChk").css("display", "none");
                        $("#trOptionalField").css("display", "none");
                        $("#spnOptionalFieldName").text("");
                        $("#lblOptionalFieldChk").text("");
                        $("#txtNextApprovalQueue").val(nextstagename);
                        $("#trNextApproverLabel").css("display", "block");
                        $("#txtNextApprovalQueue").prop("disabled", false);
                    }

                    if (parseInt(nextlevel) == parseInt(currentstage)) {
                        //alert(1);
                        $("#trOptionalChk").css("display", "none");
                        $("#trOptionalField").css("display", "none");
                        $("#spnOptionalFieldName").text("");
                        $("#lblOptionalFieldChk").text("");
                        $("#txtNextApprovalQueue").text("");
                        $("#trNextApproverLabel").css("display", "none");
                    }

                }

            },
            error: function (result) {
                jAlert("Something Went wrong", "Error");
            }
        });


        $('input:radio[name=rtbApproval]').live('change', function () {
            $.ajax({
                url: '../Onboarding/GetNextApprovalStage',
                data: JSON.stringify(objApprovalModel),
                type: 'POST',
                async: false,
                cache: false,
                contentType: 'application/json; charset=utf-8',
                success: function (data) {

                    if (data.length > 0) {
                        for (var i = 0; i < data.length; i++) {
                            ismandatoryqueue = data[i]._NextApprovalIsMandatory;
                            nextstagename = data[i]._NextApprovalGroup;
                            nextlevel = data[i]._QueueCurrentLevel;
                            queuetotype = data[i]._QueueToType;
                        }
                        if (rdbval == "1") {
                            if (queuetotype != "G") {
                                if (ismandatoryqueue == "N") {
                                    $("#trOptionalChk").css("display", "block");
                                    $("#trOptionalField").css("display", "block");
                                    $("#spnOptionalFieldName").text("Select " + nextstagename);
                                    $("#lblOptionalFieldChk").text("Is " + nextstagename + " Approval Required?");
                                    $("#txtNextApprover").prop("disabled", true);
                                    $("#trNextApproverLabel").css("display", "none");
                                    $("#btnEmployeeSearchApproval span").prop("disabled", true);
                                }
                                else {
                                    $("#trOptionalChk").css("display", "none");
                                    $("#trOptionalField").css("display", "none");
                                    $("#spnOptionalFieldName").text("");
                                    $("#lblOptionalFieldChk").text("");
                                    $("#txtNextApprovalQueue").val(nextstagename);
                                    $("#txtNextApprovalQueue").prop("disabled", true);
                                }
                            }
                        }
                        else {
                            $("#trOptionalChk").css("display", "none");
                            $("#trOptionalField").css("display", "none");
                            $("#spnOptionalFieldName").text("");
                            $("#lblOptionalFieldChk").text("");
                            $("#txtNextApprovalQueue").val(nextstagename);
                            $("#txtNextApprovalQueue").prop("disabled", true);
                        }

                    }

                },
                error: function (result) {
                    jAlert("Something Went wrong", "Error");
                }
            });
        });


    });
    $(document).ready(function () {
        //$('.glyphicon-eye-open').on('click', function () {
        //    // alert('hellow');
        //    var tr = $(this).parents('tr:first');
        //    //var Name = tr.find("#Name").val();
        //    var SurName = tr.find("#Name").val();
        //    //var UserID = tr.find("#UserID").html();
        //    //  alert(SurName);
        //    // alert(SurName);
        //    //var path = '<%=Session["path"]%>';
        //    //alert(path);
        //    if (SurName != '') {
        //        window.open("//192.168.84.94/temp/" + SurName, "_blank", "toolbar=yes, scrollbars=yes, resizable=yes, top=500, left=500, width=400, height=400");
        //      //  window.open(path + SurName, "_blank", "toolbar=yes, scrollbars=yes, resizable=yes, top=500, left=500, width=400, height=400");
        //    }
        //});
        @*var logstastus = '@Model.logstatus';
       
        if (logstastus != "N")
        {
            alert(logstastus);
            $('#btnDeactivate').prop("disabled", true);
        }
        else
        {
            //alert(logstastus);
            $('#btnDeactivate').prop("disabled", false);
        }*@
        


        var DCurentstatus = "R";
        $('#rtbApproval').change(function () {
            $('#rtbReject').removeAttr('checked');
            DCurentstatus = "A";
        });
        $('#rtbReject').change(function () {
            $('#rtbApproval').removeAttr('checked');
            DCurentstatus = "R";
        });
       
       
        $('#btnDeactivate').click(function () {
            var isexistsflag1 = '@Model._IsExistsFlagApprover';
            var isexistsapprovername1 = '@Model._IsExistsApproverName';
            if ($.trim(isexistsflag1).toString() == "Y") {
                jAlert("This Supplier Already Approved By " + isexistsapprovername1, "Error", function () {
                    var supcode = '@Model.DSupplierCode';
                    var objSupHeaderDetails = {
                        "_SupplierCode": supcode
                    };

                    $.ajax({
                        url: '@Url.Action("ReleaseMySupplier", "Onboarding")',
                        data: JSON.stringify(objSupHeaderDetails),
                        type: 'POST',
                        async: false,
                        cache: false,
                        contentType: 'application/json; charset=utf-8',
                        success: function (data) {
                            location = "../AsmsMain/Dashboard?" + new Date().getTime();
                        },
                        error: function (result) {
                            jAlert("Something went wrong", "Error");
                        }
                    });
                });
                return false;
            }
            var currentStage = '@Model.DCurrenStrage';  
           
            if (currentStage == 2) {
                if (DCurentstatus != "R") {
                    if ($('#dropProduct').val() == '') {
                        jAlert('Please Select Next Level Approver', 'Message', function () {
                            $('#dropProduct').focus();
                        });
                        return false;
                    }
                }
               
            }
                if (DCurentstatus == "R") {


                    if ($('#txtDRemarks').val().trim() == '' || $('#txtDRemarks').val() == null) {
                        jAlert('Please Fill Remarks Field', 'Message', function () {
                            $('#txtDRemarks').focus();
                        });
                        return false;
                    }
                }
               
                showProgress();
        
        
        });
        


    });
 
</script>